# 文件解析器代码生成 Prompt

## 项目背景说明
我们正在开发一个**代码来源检测系统**，该系统能够分析源代码文件，判断其是由人类编写还是AI生成。系统采用分层架构，其中文件解析器是前端核心组件，负责将原始代码转换为结构化数据，供后续的特征提取和机器学习模型使用。

文件解析器的关键设计要求：
1. 输入：原始代码文件（路径+内容）
2. 输出：标准化的结构化数据
3. 功能：
   - 自动识别编程语言
   - 提取文件级上下文（文件名、导入、类/函数名）
   - 行级分解与特征提取（AST、上下文窗口）
4. 支持语言：Python、Java、JavaScript
5. 鲁棒性：优雅处理解析错误

## 代码生成 Prompt

```markdown
请开发一个Python文件解析器类，用于代码来源检测系统。具体要求如下：

### 类名
`CodeFileParser`

### 输入格式
```json
{
  "file_path": "可选文件路径",
  "content": "代码内容字符串"
}
```

### 输出格式
```json
{
  "language": "检测到的编程语言",
  "file_context": {
    "file_name": "从路径提取的文件名",
    "imports": ["导入的库列表"],
    "class_name": "当前类名/null",
    "function_name": "当前函数名/null"
  },
  "lines": [
    {
      "line_number": 行号,
      "content": "原始代码行",
      "ast_features": {
        "node_type": "AST节点类型",
        "depth": "AST深度",
        "children_types": ["子节点类型列表"]
      },
      "context_window": [
        {"line": 行号, "content": "上下文行内容"},
        ...
      ]
    },
    ...
  ]
}
```

### 核心功能要求
1. **语言检测**：
   - 优先根据文件扩展名判断
   - 无扩展名时使用启发式规则：
     - Python: 包含"def "和"import "
     - Java: 包含"public class "
     - JavaScript: 包含"function "和"=>"
   - 支持语言：Python, Java, JavaScript

2. **文件上下文提取**：
   - 文件名：从`file_path`提取或默认"unknown"
   - 导入解析：
     - Python: 匹配`import `和`from ... import`
     - Java: 匹配`import ...;`
     - JavaScript: 匹配`import `和`require(`
   - 类/函数名检测：
     - 使用AST分析找到最近的类/函数上下文

3. **行级解析**：
   - 每行包含原始内容和行号
   - AST特征提取：
     - 使用语言对应的AST解析器
     - 捕获节点类型、深度和直接子节点类型
   - 上下文窗口：
     - 默认窗口大小：当前行±2行
     - 自适应调整（函数/类边界扩展窗口）

4. **错误处理**：
   - AST解析错误时返回"unknown"类型
   - 捕获所有异常，不中断整个文件解析
   - 记录错误日志但继续处理

5. **AST处理要求**：
   - Python: 使用`ast`模块
   - Java: 使用`javalang`包（需安装）
   - JavaScript: 使用`esprima`包（需安装）

### 代码结构要求
```python
class CodeFileParser:
    def __init__(self, context_window_size=2):
        """
        初始化解析器
        :param context_window_size: 上下文窗口大小（当前行前后行数）
        """
        self.context_window_size = context_window_size
        # 初始化语言检测器、AST解析器等
    
    def parse(self, input_data: dict) -> dict:
        """
        主解析方法
        :param input_data: 输入字典 {"file_path": str, "content": str}
        :return: 结构化解析结果字典
        """
        # 实现步骤：
        # 1. 提取文件路径和内容
        # 2. 识别编程语言
        # 3. 解析文件级上下文
        # 4. 解析行级信息（含AST和上下文窗口）
        # 5. 组装结果
        
    # 以下是内部辅助方法（实现细节由你决定）
    def _detect_language(self, content: str, file_path: str = None) -> str:
        """检测编程语言"""
    
    def _parse_file_context(self, content: str, language: str) -> dict:
        """解析文件级上下文"""
    
    def _parse_lines(self, content: str, language: str) -> list:
        """解析行级信息"""
    
    def _extract_ast_features(self, line_content: str, line_num: int, 
                             full_content: str, language: str) -> dict:
        """提取行的AST特征"""
    
    def _build_context_window(self, lines: list, current_index: int) -> list:
        """构建上下文窗口"""
```

### 注意事项
1. 不生成`source`, `metadata`, `id`字段
2. 对于无法解析的语言，返回基本行信息（AST标记为unknown）
3. 使用try-except确保单行解析错误不影响整个文件
4. 为Java/JavaScript提供降级方案（当依赖包未安装时）
5. 优化大文件处理性能

### 示例调用
```python
parser = CodeFileParser()
input_data = {
    "file_path": "/projects/math_utils.py",
    "content": "import math\n\ndef factorial(n):\n    return 1 if n <= 1 else n * factorial(n-1)"
}
result = parser.parse(input_data)
```

请实现完整的`CodeFileParser`类，包含必要的内部方法和详细的错误处理逻辑。
```

这个Prompt提供了清晰的项目背景、具体要求、输入输出格式和实现指南，能够指导代码助手生成符合系统需求的文件解析器。关键点包括：

1. **明确边界**：只处理代码到结构化数据的转换，不涉及来源判断
2. **语言支持**：聚焦Python/Java/JavaScript三种核心语言
3. **错误处理**：强调鲁棒性和错误隔离
4. **性能考量**：要求优化大文件处理
5. **扩展性**：通过参数化设计支持未来扩展

此设计确保文件解析器能够高效、可靠地将原始代码转换为下游组件可用的标准化结构，为整个代码来源检测系统奠定坚实基础。